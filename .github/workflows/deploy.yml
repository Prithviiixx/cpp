name: Deploy Flask App to EC2

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Stop existing Flask app if running
            pkill -f "python3.*app.py" || true
            sleep 2
            
            # Remove existing app directory
            sudo rm -rf /home/ec2-user/app
            
            # Clone fresh repository
            git clone https://github.com/Prithviiixx/cpp.git /home/ec2-user/app
            
            # Install dependencies
            cd /home/ec2-user/app
            pip3 install flask flask-sqlalchemy werkzeug boto3 --user
            
            # Create startup script
            cat > /home/ec2-user/start_app.sh << 'EOF'
            #!/bin/bash
            cd /home/ec2-user/app
            python3 app.py >> /home/ec2-user/flask_app.log 2>&1
            EOF
            
            chmod +x /home/ec2-user/start_app.sh
            
            # Start app using nohup with setsid to fully detach
            setsid nohup /home/ec2-user/start_app.sh &
            
            sleep 2
            echo "Deployment completed!"
