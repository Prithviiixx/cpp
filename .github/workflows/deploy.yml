name: Deploy Flask App to EC2

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/ec2_key ec2-user@${{ secrets.EC2_HOST }} 'bash -s' << 'ENDSSH'
          # Kill existing app
          pkill -f "python3.*app.py" || true
          sleep 1
          
          # Clean and clone
          sudo rm -rf /home/ec2-user/app
          git clone https://github.com/Prithviiixx/cpp.git /home/ec2-user/app
          
          # Install deps
          cd /home/ec2-user/app
          pip3 install flask flask-sqlalchemy werkzeug boto3 --user
          
          # Create systemd service
          sudo tee /etc/systemd/system/flaskapp.service > /dev/null << 'EOF'
          [Unit]
          Description=Flask Agriculture App
          After=network.target
          
          [Service]
          User=ec2-user
          WorkingDirectory=/home/ec2-user/app
          ExecStart=/usr/bin/python3 /home/ec2-user/app/app.py
          Restart=always
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Start service
          sudo systemctl daemon-reload
          sudo systemctl enable flaskapp
          sudo systemctl restart flaskapp
          
          echo "Deployment completed!"
          ENDSSH
